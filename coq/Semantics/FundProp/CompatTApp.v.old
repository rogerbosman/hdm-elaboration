Set Warnings "-notation-overridden,-intuition-auto-with-star".

Require Import Preamble.

Require Import Defs.Lc.
Require Import Defs.Sub.
Require Import Defs.Subx.
Require Import Defs.TmTy.
Require Import Defs.WfSTt.

Require Import Semantics.ClosedVals.
Require Import Semantics.Compositionality.
Require Import Semantics.gamma.
Require Import Semantics.EquivRel.
Require Import Semantics.LogRel.
Require Import Semantics.LogRelEProps.
Require Import Semantics.logrel_val_props.
Require Import Semantics.Opsem.
Require Import Semantics.rho.

(*** TApp *)
(* Fact wf_Sub_app_T : forall Ïˆ Î¸ Ï„, *)
(*     Ïˆ âŠ¢Î¸ Î¸ *)
(*   -> Ïˆ âŠ¢wfÏ„ Ï„ *)
(*   -> Ïˆ âŠ¢wfÏ„ âŸ¦Î¸ â–¹ Ï„âŸ§. *)
(* Admitted. *)

(* Fact Ï_in_ğ’Ÿ_wf_Sub1 : forall Ï Ïˆ, *)
(*     Ï âˆˆ ğ’ŸâŸ¦ÏˆâŸ§ *)
(*   -> â€¢ âŠ¢Î¸ Ï€1 Ï. *)
(* Admitted. *)
(* Fact Ï_in_ğ’Ÿ_wf_Sub2 : forall Ï Ïˆ, *)
(*     Ï âˆˆ ğ’ŸâŸ¦ÏˆâŸ§ *)
(*   -> â€¢ âŠ¢Î¸ Ï€2 Ï. *)
(* Admitted. *)
(* #[export] Hint Resolve Ï_in_ğ’Ÿ_wf_Sub1 Ï_in_ğ’Ÿ_wf_Sub2 : core. *)

(* Lemma Sub_app_T_lc : forall (Î¸:Sub) (Ï„:T), *)
(*     lc(Ï„) *)
(*   -> lc(Î¸) *)
(*   -> lc(âŸ¦Î¸ â–¹ Ï„âŸ§). *)
(* Admitted. *)


Lemma Rel_logrel_val : forall Ï„ Ï,
    Rel (logrel_val (S__T Ï„) Ï) âŸ¦Ï€1 Ï â–¹ Ï„âŸ§ âŸ¦Ï€2 Ï â–¹ Ï„âŸ§.
Proof. intros. unfolds. intros. destruct Ï„; simp' in H; crush. Qed.

Lemma CompatTApp : forall Ïˆ t t' Ïƒ Ï„,
    Ïˆ âŠ¢tâ‰ˆ t â‰ˆ t' â–¸ S__Forall Ïƒ
  -> Ïˆ âŠ¢wfÏ„ Ï„
  -> Ïˆ âŠ¢tâ‰ˆ t__TApp t Ï„ â‰ˆ t__TApp t' Ï„ â–¸ open_Sc_wrt_T Ïƒ Ï„.
Proof.
  introv [TmTy1 [TmTy2 IH]] WF. splits.
  - crush.
  - crush.
  - introv IN. specializes IH IN. destruct IH as [TmTyCl1 [TmTyCl2 [v1 [v2 [OP1 [OP2 VAL]]]]]].
    simpl+. splits.
    + forwards H: TmTy_close1 Ï Î³. apply TmTy__TApp. eassumption. apply TmTy1. eassumption.
      simpl+ in H. eassumption.
    + forwards H: TmTy_close2 Ï Î³. apply TmTy__TApp. eassumption. apply TmTy2. eassumption.
      simpl+ in H. eassumption.
    + simp' in VAL. destruct VAL as [CLV [t1' [t2' [EQ1 [EQ2 IH]]]]]. subst.
      specializes IH (âŸ¦Ï€1 Ï â–¹ Ï„âŸ§) (âŸ¦Ï€2 Ï â–¹ Ï„âŸ§) (logrel_val (S__T Ï„) Ï). destruct IH as [L IH].
      forwards [Î± NIL__Î±]: atom_fresh (L âˆª ((fv__Î±(Ïƒ) âˆª dom_rho Ï) âˆª skvars_codom_rho Ï)).
      specializes IH Î±. specializes IH. fsetdec. simpl+.
      splits; try eauto using Rel_logrel_val, T_close1, T_close2 with slow.
      destruct IH as [TMTY1 [TMTY2 [v1 [v2 [OP1' [OP2' IH]]]]]].
      apply Compositionality in IH. 2:fsetdec.
      2:apply rho_lc_cons; eauto using Sub_app_T_lc.
      do 2 eexists. splits. 3:apply IH.
      * etransitivity. rewrite <- make_EC_t__TApp. apply t_ss__EC_refl_trans. eassumption.
        simpl+. eauto.
      * etransitivity. rewrite <- make_EC_t__TApp. apply t_ss__EC_refl_trans. eassumption.
        simpl+. eauto.
      * eauto.
      * eauto using T_close1.
      * eauto using T_close2.
      * eauto using logrel_E_skvars_codom_rho_empty.
Qed.
